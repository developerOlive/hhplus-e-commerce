# 🟣 성능 테스트 계획서
<br>

## 1. 테스트 개요 / 시나리오
마케팅팀은 오는 2025년 O월 O일 O시에 <br>
선착순 1만 명 한정, 50% 할인 쿠폰 발급 이벤트를 진행할 예정입니다.<br><br>

이벤트 시작 직후 짧은 시간 동안 사용자 요청이 급격히 몰릴 것으로 예상되며<br>
단기간 내 고강도의 트래픽이 집중될 수 있습니다.<br><br>

이번 테스트는 4 vCPU / 6GB 메모리의 단일 애플리케이션 서버 환경에서 <br>
고강도 트래픽 상황에서의 최대 처리 가능 수준과 안정성 유지 한계를 측정하는 데 목적이 있습니다. <br><br>

이는 이벤트 오픈 시점의 예상되는 서버 구성과 동일한 조건으로<br>
자동 스케일아웃이 아직 적용되지 않은 초기 상태에서<br>
사용자 요청이 정상적으로 처리되는지를 검증하고자 합니다.

<br><br>

---

## 2. 서비스 수준 목표 (SLO / SLI / SLA)

<br>

### ✅ SLI (측정 지표)

| 항목                   | 설명                                                 |
|----------------------|----------------------------------------------------|
| API 응답 시간 (Latency) | 평균, P90, P95 응답 시간 측정 (Grafana 기준)                |
| API 처리량 (TPS)        | 초당 발급 성공 요청 수                                       |
| API 에러율              | 전체 요청 대비 실패 비율                                    |
| 시스템 자원 사용률         | CPU, Memory, Network I/O, DB 커넥션 사용량 *(별도 모니터링 필요)* |
| 데이터 정합성              | 중복 발급, 재고 초과 발급 발생 여부 *(409 응답으로 차단 여부 포함)*     |

<br>

### 🎯 SLO (목표 수치)

| 항목              | 목표                                 |
|-----------------|------------------------------------|
| **P95 응답 시간**     | **500ms 이내**                       |
| **에러율**           | **1% 미만** (정합성 오류 포함 시에도 총합 1% 이내) |
| **단일 서버 TPS**     | **평균 400~500 수준, 스파이크 시 1,300 이상 도달 가능**                               |
| **중복/초과 발급**     | **0건** (모두 서버에서 차단되어야 함)           |

<br>

### 🤝 SLA (서비스 약속)

| 항목                  | 약속                                     |
|---------------------|----------------------------------------|
| **시스템 가용성**         | 99.9% 이상                                 |
| **이벤트 초기 성공률**     | 시작 후 10분 내 99% 이상 성공 처리              |

<br><br>

---

## 3. 부하 테스트 시나리오

### 3.1 이벤트 비즈니스 배경
- 목표: 선착순 1만 명에게 50% 할인 쿠폰 발급
- 트래픽 특성: 이벤트 시작 직후 급격한 스파이크 발생 예상

핵심 요구사항
- 사용자당 1회 발급
- 재고 초과/마감 후 발급 불가
- 중복 요청에 대한 일관된 처리
- 일정 수준의 응답 지연은 허용하되 정합성 최우선
- 장애 시 원인 추적 가능

<br><br>

### 3.2 테스트 환경 및 설정
테스트는 Docker 기반의 단일 서버 환경에서 진행되었으며<br>
컨테이너 실행 시 다음과 같은 리소스 제한을 적용했습니다.<br><br>

| 구성 요소             | CPU 할당량    | 메모리 할당량   |
|----------------------|---------------|----------------|
| App (Spring Boot)    | 4 vCPU        | 6GB            |
| Redis                | 0.5 vCPU      | 512MB          |
| Kafka                | 1 vCPU        | 1GB            |
| MySQL                | 1 vCPU        | 2GB            |
| MongoDB              | 0.5 vCPU      | 1GB            |
| InfluxDB             | 0.5 vCPU      | 512MB          |
| Grafana              | 0.5 vCPU      | 512MB          |

<br>

이 설정은 docker-compose.yml의 deploy.resources.limits 항목을 통해 지정되었으며<br>
테스트는 이 자원 범위 내에서의 처리 성능을 측정하는 데 초점을 맞추었습니다.<br>

<br><br>

### 3.3 테스트 도구 및 구성

| 항목             | 내용                                                              |
|------------------|-----------------------------------------------------------------|
| 테스트 도구         | K6 (JavaScript 기반)                                                |
| 선정 이유          | 경량 고성능, 스크립트 작성 용이, 다양한 시나리오 정의 가능                            |
| 대상 시스템 구성     | Docker 단일 인스턴스 (4 vCPU, 6GB RAM)                                  |
| 모니터링 도구      | Grafana + InfluxDB (K6 결과 수집 및 시각화용)                             |
| 측정 지표 범위       | 응답 시간, TPS, 에러율, 정합성 상태, 시스템 자원 사용률 (CPU, Memory, DB 커넥션 등) |

<br><br>

### 3.4 테스트 대상 API
URL: POST `/api/v1/users/{userId}/coupons/{couponId}/issue`

성공 응답 예시
```json
{
  "message": "요청이 성공적으로 처리되었습니다.",
  "data": "발급 요청 성공",
  "success": true
}
```

실패 응답 예시
```json
{
  "message": "이미 발급된 쿠폰입니다.",
  "data": null,
  "success": false
}
```

<br><br>

---

## 4. 부하 테스트 시나리오 상세

### 🟡 시나리오 : Peak Test (스파이크 트래픽) 
<br>
(1) 목적 <br>
이 시나리오는 단일 서버 환경에서 단시간 내 급격히 증가하는 사용자 요청에 대해<br>
시스템이 감당할 수 있는 최대 처리량과 안정성 한계를 파악하는 데 목적이 있습니다.<br>
초기 자동 스케일아웃 없이, 정해진 리소스(4 vCPU, 6GB) 내에서<br>
시스템이 어느 시점까지 정상 응답을 유지할 수 있는지 관찰합니다.<br>

<br>

(2) 테스트 케이스

| 테스트 이름              | 설명                                                      |
|-----------------------|---------------------------------------------------------|
| **Peak Test 1 (1,000 VU)** | 30초 내 1,000명 도달 → 1분 유지 → 30초 동안 감소<br>→ 정상 동작 기준선 확인     |
| **Peak Test 2 (2,000 VU)** | 30초 내 2,000명 도달 → 1분 유지 → 점진적 감소<br>→ 부하 증가 시 처리 지연 여부 확인 |

> 💡 3,000 VU 테스트는 3,000명 부하 시점에서 이미 시스템이 견디지 못하는 현상이 확인되어 제외함


<br>

(3) 트래픽 패턴 (각 테스트 동일)

| 구간               | 설명                                                                      |
|------------------|---------------------------------------------------------------------------|
| **초기 증가 구간**    | 20초 동안 초당 50명 도달, 이후 점진적으로 300명/초까지 증가 (총 2분 소요)                      |
| **최대 부하 유지**   | 초당 300명 도달 후, 1분간 동일 속도 유지                                         |
| **종료 구간**       | 20초 동안 도달률을 0으로 줄이며 점진적으로 종료                                     |
| **총 테스트 시간**   | 약 3분 20초 + graceful stop 10초 포함 → **약 3분 30초 내외**                      |

<br>

본 시나리오는 ramping-arrival-rate 전략을 기반으로 구성되었으며<br>
초당 도달 요청 수(RPS)를 점진적으로 증가시키는 방식으로 설계되었습니다.<br>
약 2분간 초당 50 → 300 요청까지 점차 증가시키고<br>
이후 1분간 최대 부하를 유지한 뒤<br>
20초 동안 점진적으로 감소하여 테스트를 종료합니다.<br>

<br>

(4) 측정 항목

| 항목               | 설명                                                    |
| ---------------- |-------------------------------------------------------|
| **최대 RPS (TPS)** | 테스트 중 관찰된 초당 최대 처리 요청 수         |
| **P95 응답 시간**    | 전체 요청 중 95%가 이내에 처리된 응답 시간      |
| **에러율**          | HTTP 오류(5xx) 및 비즈니스 오류(중복 발급 등 4xx)의 비율               |
| **리소스 사용률**      | CPU, Memory, DB 커넥션 등의 자원 사용량은 Grafana/InfluxDB로 수집해 분석 |


<br><br>

---
